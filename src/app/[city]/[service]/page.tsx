import { notFound } from "next/navigation";
import { Suspense } from "react";
import { getServiceData, getAvailableCities, getCityServices, getCityData } from "@/lib/data-service";
import TariffExplorer from "@/components/blocks/TariffExplorer";
import CityServiceLayout from "@/components/layout/CityServiceLayout";

export const revalidate = 3600;
function formatServiceName(type: string): string {
  const parts = type
    .toLowerCase()
    .split(/\s*\+\s*/)
    .map((s) => s.trim());

  const hasInternet = parts.some((p) => p.includes("–∏–Ω—Ç–µ—Ä–Ω–µ—Ç"));
  const hasTV = parts.some((p) => p.includes("—Ç–≤"));
  const hasMobile = parts.some((p) => p.includes("–º–æ–±"));

  if (hasInternet && hasTV && hasMobile) {
    return "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –¢–í –∏ –º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å";
  }
  if (hasInternet && hasTV) {
    return "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ";
  }
  if (hasInternet && hasMobile) {
    return "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å";
  }
  if (hasTV && hasMobile) {
    return "–¢–í –∏ –º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å";
  }
  if (hasInternet) return "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç";
  if (hasTV) return "–¢–í";
  if (hasMobile) return "–º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å";

  return type; // fallback
}
export async function generateMetadata({ params }: { params: { city: string; service: string } }) {
  const { city, service } = params;
  
  const cityData = await getCityData(city);
  const data = await getServiceData(city, service);

  if (!cityData || !data) {
    return {
      title: '–¢–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
      description: '–£–∫–∞–∑–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –∏–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.',
    };
  }

  const cityName = cityData.meta.name || city;
  const serviceTitle = data.title || service;

  let title = "";
  let description = "";

  if (service === "internet") {
    title = `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–¢–° –≤ ${cityName} ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–¢–° –≤ –∫–≤–∞—Ä—Ç–∏—Ä—É, —Ç–∞—Ä–∏—Ñ—ã –≤ 2025 –≥–æ–¥—É`;
    description = `–î–µ–π—Å—Ç–≤—É—é—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã –ú–¢–° –Ω–∞ –¥–æ–º–∞—à–Ω–∏–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤ 2025 –≥–æ–¥—É. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ –≤ ${cityName}. –û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ.`;
  } else if (service === "internet-tv") {
    title = `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç + –¢–í –ú–¢–° –≤ ${cityName} ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å —É—Å–ª—É–≥, —Ç–∞—Ä–∏—Ñ—ã –≤ 2025 –≥–æ–¥—É`;
    description = `–¢–∞—Ä–∏—Ñ—ã –ú–¢–° –Ω–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ –≤ ${cityName}. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —É—Å–ª—É–≥ –ú–¢–° –≤ 2025 –≥–æ–¥—É.`;
  } else if (service === "internet-mobile") {
    title = `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç + –º–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –ú–¢–° –≤ ${cityName} ‚Äî —Ç–∞—Ä–∏—Ñ—ã –≤ 2025 –≥–æ–¥—É`;
    description = `–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –ú–¢–° –Ω–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å –≤ ${cityName}. –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥ –ú–¢–°–∞.`;
  } else if (service === "internet-tv-mobile") {
    title = `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç + –¢–í + –º–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –ú–¢–° –≤ ${cityName} ‚Äî —Ç–∞—Ä–∏—Ñ—ã –≤ 2025 –≥–æ–¥—É`;
    description = `–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –ú–¢–° –≤ ${cityName}, –≤–∫–ª—é—á–∞—é—â–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –¢–í –∏ –º–æ–±–∏–ª—å–Ω—É—é —Å–≤—è–∑—å. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω.`;
  } else {
    // fallback
    title = `–¢–∞—Ä–∏—Ñ—ã –ú–¢–° –≤ ${cityName}`;
    description = `–¢–∞—Ä–∏—Ñ—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ú–¢–° –≤ ${cityName}.`;
  }

  return {
    title,
    description,
    openGraph: {
      title,
      description,
      images: ["https://mts-telecom.ru/android-icon-192x192.png"],
    },
    alternates: {
      canonical: `https://–≤–∞—à-–¥–æ–º–µ–Ω.—Ä—É/${city}/${service}`,
    },
  };
}
export async function generateStaticParams() {
  const cities = await getAvailableCities();
  const params = [];
  for (const city of cities) {
    const services = await getCityServices(city);
    for (const service of services) {
      params.push({ city, service });
    }
  }
  return params;
}

export default async function ServicePage({ params }: { params: { city: string; service: string } }){
  const { city, service } = params;

  const data = await getServiceData(city, service);
  if (!data) return notFound();

const cityData = await getCityData(city);
if (!cityData) return notFound();

const cityName = cityData.meta.name;
const serviceTitle = formatServiceName(data?.tariffs?.[0]?.type || service);
const allTariffs = Object.values(cityData.services).flatMap((s) => s.tariffs);
  console.log('sdsd')     // –Ω–∞–ø—Ä–∏–º–µ—Ä "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç"
console.log('—Ç–∏—Ç–ª',serviceTitle)
// –≤–Ω—É—Ç—Ä–∏ ServicePage
const rawServiceType = data.tariffs[0]?.type || serviceTitle;
const formattedServiceName = formatServiceName(rawServiceType);


return (
  <CityServiceLayout service={serviceTitle} cityName={cityName} citySlug={city}>
    <Suspense fallback={<div className="flex justify-center items-center min-h-[400px]">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤...</div>}>
      <TariffExplorer
        tariffs={allTariffs} // üëà –∑–¥–µ—Å—å –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã –≥–æ—Ä–æ–¥–∞
        cityName={cityName}
        service={serviceTitle}
        citySlug={city}
        titleservice={data.title || service}
        origservice={service}
      />
    </Suspense>
  </CityServiceLayout>
);
}
